<%
  print _site.header(_("Search for tasks"))
%>

<form method="get">
<%=Knj::Web.hiddens([{:name => :show, :value => :task_search}, {:name => :choice, :value => :dosearch}])%>

<%=_site.boxt(_("Enter criteria"), 350)%>
  <table class="form">
    <%
      print _kas.inputs({
        :title => _("Name"),
        :name => :texname,
        :value => _get["texname"],
        :descr => _("A part of the name of the task you are looking for.")
      },{
        :title => _("Description"),
        :name => :texdescr,
        :value => _get["texdescr"],
        :descr => _("A part of the description of the task you are looking for.")
      },{
        :title => _("Status"),
        :name => :selstatus,
        :opts => {"" => _("All")}.merge(_ob.static(:Task, :status_opts)),
        :descr => _("If you only want to find tasks with a specific status."),
        :value => _get["selstatus"]
      },{
        :title => _("Type"),
        :name => :seltype,
        :opts => {"" => _("All")}.merge(_ob.static(:Task, :type_opts)),
        :descr => _("If you only want to find tasks of a specific type."),
        :value => _get["seltype"]
      },{
        :title => _("User"),
        :name => :seluser,
        :opts => _ob.list_optshash(:User, {:all => true, :list_args => {"orderby" => "username"}}),
        :value => _get["seluser"],
        :descr => _("If you only want to see tasks from a specific user.")
      })
    %>
    <tr>
      <td colspan="2" class="buttons">
        <input type="button" value="<%=_"Add new"%>" onclick="location.href='?show=task_edit';" />
        <input type="submit" value="<%=_"Search"%>" />
      </td>
    </tr>
  </table>
<%=_site.boxb%>

</form>

<script type="text/javascript">
  $("#texname").focus();
</script>

<%
  if _get["choice"] == "dosearch"
    args = {"orderby" => "name"}
    args["name_search"] = _get["texname"] if _get["texname"].to_s.length > 0
    args["descr_search"] = _get["texdescr"] if _get["texdescr"].to_s.length > 0
    args["status"] = _get["selstatus"] if _get["selstatus"].to_s.length > 0
    args["type"] = _get["seltype"] if _get["seltype"].to_s.length > 0
    args["user_id"] = _get["seluser"] if _get["seluser"].to_i > 0
    
    %>
      <br />

      <%=_site.boxt(_("Results"), 900)%>
        <table class="list">
          <thead>
            <tr>
              <th><%=_"Name"%></th>
              <th><%=_"Status"%></th>
              <th><%=_"Project"%></th>
              <th><%=_"Author"%></th>
            </tr>
          </thead>
          <tbody>
            <%
              count = 0
              _ob.list(:Task, args) do |task|
                next if !task.has_view_access?(_site.user)
                count += 1
                
                %>
                  <tr>
                    <td>
                      <%=task.html%>
                    </td>
                    <td>
                      <%=task.status_str.html%>
                    </td>
                    <td>
                      <%=task.project_html%>
                    </td>
                    <td>
                      <%=task.user_html%>
                    </td>
                  </tr>
                <%
              end
              
              if count <= 0
                %>
                  <tr>
                    <td colspan="1" class="error">
                      <%=_("No tasks were found.")%>
                    </td>
                  </tr>
                <%
              end
            %>
          </tbody>
        </table>
      <%=_site.boxb%>
    <%
  end
%>