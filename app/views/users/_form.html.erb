<%
  if !can?(:admin, :admin)
    flash[:warning] = (_("You are not an administrator and cannot view this page."))
    redirect_to :back
  end
  
  if params["choice"] == "dosave"
    save_hash = {
      :name => params["texname"],
      :username => params["texusername"],
      :email => params["texemail"],
      :active => Knj::Web.checkval(params["cheactive"], 1, 0)
    }
    
    if params["texpasswd_md5"].to_s.length > 0 and params["texpasswd_md5"] != Php4r.md5("")
      save_hash[:passwd] = params["texpasswd_md5"]
    end
  end
  
  if params["choice"] == "dologinas"
    _session[:user_id] = user.id
    redirect_to("?show=user_login")
  end
  
  if params["choice"] == "doremoverank"
    link = _ob.get(:User_rank_link, params["link_id"])
    _ob.delete(link)
    exit
  end
  
  if params["choice"] == "doaddrank"
    begin
      link = _ob.add(:User_rank_link, {
        :user_id => user.id,
        :rank_id => params["rank_id"]
      })
    rescue => e
      print e.message
    end
    
    exit
  end
%>

<%= simple_form_for @user, :html => {:autocomplete => "off"} do |f| %>
<%= Knj::Web.hiddens([{:name => :texpasswd_md5, :value => ""}]).html_safe %>

<%=DesignBox.boxt(_("Enter details"), 350)%>
  <table class="form">
    <%= Knj::Web.inputs([{
      :title => _("Username"),
      :name => "user[username]",
      :value => @user.username,
      :descr => _("The username that this user should use to log in.")
    },{
      :title => _("Password"),
      :name => "user[password]",
      :value => "",
      :type => :password,
      :descr => _("Only write a password here if you whish to change it.")
    },{
      :title => _("Name"),
      :name => "user[name]",
      :value => @user.name,
      :descr => _("The real name of the user.")
    },{
      :title => _("Email"),
      :name => "user[email]",
      :value => @user.email,
      :descr => _("The email of the user which will be used for notifications and other stuff as well.")
    },{
      :title => _("Active"),
      :type => :checkbox,
      :name => "user[active]",
      :value => @user.active?,
      :descr => _("If the user is active or not. In-active users cant log in.")
    }]).html_safe %>
    <tr>
      <td colspan="2" class="buttons">
        <%if !@user.new_record?%>
          <%= link_to _("Log in as"), log_in_as_user_path(@user), :method => :post, :data => {:confirm => _("Are you sure?")} %>
          <input type="button" value="<%=_"Show"%>" onclick="location.href='<%= user_path(@user) %>';" />
          <%= link_to _("Delete"), user_path(@user), :method => :delete, :class => "button", :data => {:confirm => _("Are you sure?")} %>
        <%end%>
        <input type="submit" value="<%=_"Save"%>" />
      </td>
    </tr>
  </table>
<%=DesignBox.boxb%>

<% end %>

<%if !@user.new_record?%>
  <br />

  <%=DesignBox.boxt(_("Permissions"), 350)%>
    <div style="padding-bottom: 15px;">
      <input type="button" value="<%=_"Add rank"%>" onclick="modal({title: '<%=_"Add rank"%>', url: '/clean.rhtml?show=user_rank_search&amp;jsfunc=rank_add'});" />
    </div>
    
    <div id="divpermissions">
      <div class="error">
        <%=_"Loading - please wait..."%>
      </div>
    </div>
  <%=DesignBox.boxb%>
<%end%>

<script type="text/javascript">
  $("#texusername").focus();
  
  function do_save_user(){
    $("input[name=texpasswd_md5]").val($.md5($("#texpasswd").val()));
    $("#texpasswd").val("");
    return true;
  }
  
  <%if !@user.new_record?%>
    function ranks_reload(){
      $.ajax({type: "GET", url: "<%= roles_user_path(@user) %>", async: true, cache: false, complete: function(data){
        $("#divpermissions").slideUp("fast", function(){
          $("#divpermissions").html(data.responseText);
          $("#divpermissions").slideDown("fast");
        });
      }});
    }
    
    function rank_remove(link_id){
      $.ajax({type: "DELETE", url: "/user_roles/" + link_id, async: true, cache: false, complete: function(data){
        if ($.trim(data.responseText).length > 0){
          alert(data.responseText);
        }
        
        ranks_reload();
      }});
    }
    
    function rank_add(rank_id){
      modal_close();
      
      $.ajax({type: "GET", url: "/clean.rhtml?show=user_edit&choice=doaddrank&user_id=<%=@user.id%>&rank_id=" + rank_id, async: true, cache: false, complete: function(data){
        if (data.responseText.length > 0){
          alert(data.responseText);
        }
        
        ranks_reload();
      }});
    }
    
    $(document).ready(function(){
      ranks_reload();
    });
  <%end%>
</script>